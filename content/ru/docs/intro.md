---
title: "Назначение"
description: "Какие задачи решает проект"
date: 2020-01-28T00:34:51+09:00
draft: false
weight: 1
---
# pgmig - **p**ost**g**resql database **mig**rations

pgmig - это инструмент для управления изменениями схемы БД postgresql, который добавляет изменениям следующие возможности

* изменения выполняются в одной транзакции загрузкой исходного кода из файлов в алфавитном порядке их имен
* имена файлов с хранимым кодом и его тестами имеют заданную маску и они выполняются при любом изменении
* для отката от версии Б к версии А достаточно иметь содержимое БД (версии Б) и исходники версии А
* номер версии БД может определяется по git-атрибутам загружаемого исходного кода
* история изменений хранимого кода контролируется git

## Варианты изменения схемы БД

### Обновление (up)

Представляет собой загрузку в БД (выполнение) всех файлов с маской `*.sql`, которые не были загружены ранее или соответствуют маске `--func_mask`, в алфавитном порядке. В первом случае в БД сохраняется контрольная сумма файла и, если при будущем обновлении обнаружится изменение контрольной суммы файла на диске, будет выведено предупреждение. Также для каждого файла в БД сохраняется номер текущей версии.

* Корневой каталог для загружаемых файлов задается аргументом `--dir`.
* Подкаталоги просматриваются в алфавитном порядке
* Подкаталоги и файлы, имена которых начинаются с точки, игнорируются.

### Откат (down)

В терминах `pgmig`, откат означает отмену обновлений, сделанных после текущей версии, и представляет собой выполнение блоков отката для всех файлов с версией больше текущей (в обратном алфавитному порядке) и последующее выполнение всех файлов, которые соответствуют маске `--func_mask`, в алфавитном порядке.

#### Блоки отката

Размещаются в .sql файлах и содержат команды, отменяющие содержащиеся в них изменения схемы БД

По умолчанию блок отката имеет вид:

```sql
SELECT pgmig.down($_$
   drop index yy;
   drop table xx;
$_$);
```

Такой вариант позволяет выполнить файл с помощью `psql` без изменений.

Для совместимости с другими инструментами, поддерживается вариант, когда блок отката отделяется от основного кода разделителем, заданным в аргументе `--down-delimiter`. Содержимое файла после первого вхождения этого разделителя используется как аргумент в `pgmig.down` при выполнении `обновления`.

### Перезагрузка (реновация?) (reup (build?))

Повторная загрузка файлов текущей версии (если версия БД новее версии файлов, выполнение завершается с ошибкой).
Представляет собой выполнение блоков отката для всех файлов с именем, которое в алфавитном порядке идет после заданного аргументом `--target` (по умолчанию: 10_schema.sql) и последующее выполнение `обновления`.

Специальные значения аргумента `--target`

* `last` - выполняется только блок отката последнего файла
* `all` - блоки отката выполняются для всех файлов в каталоге
* `reset` - блоки отката выполняются для всех файлов в каталоге, `обновление` не выполняется

### Другие команды

* `load` - выполнить файлы, заданные `--func-mask`
* `status` - вывести список "пакет:версия" если пакетов >1 или просто версию пакета или отсутствие 
* `version` - вывести версию pgmig

## Версии БД

При выполнении миграций используется номер текущей версии. Он может быть свой для каждого каталога и определяется аргументом `--version`

Специальные значения аргумента `--version`

* `git` - взять версию из .gitinfo (если есть) или метаданных git-репозитория (иначе)
* `gitinfo` - взять версию из .gitinfo
* `prefix` - взять версию из префикса файла

Если источником задан git, номер текущей версии берется из метаданных git-репозитория, которые могут быть привязаны к текущему каталогу или его предку.

## Опции

* --dir (каталог, где лежат пакеты, или сразу исходники если список пакетов пуст)
* --verbose
* --nocommit (exitstatus вернет наличие ошибок)
* --json - форматировать вывод как список json

## Дополнения

Миграция прерывается при одном из условий

* после обработки всех файлов каталога зафиксирована ошибка в тестах
* при обработке файла зафиксирована иная ошибка

Вариант миграции может задаваться аргументом `--cmd`

## Переменные

Перед загрузкой в БД файла или выполнением блока отката, в БД устанавливаются значения переменных

* pgmig.var_file()
* pgmig.var_path()
* pgmig.var_version()

## Структура проекта pgmig

* / - golang-пакет для встраивания в приложения
* /cmd/pgmig - приложение для управления изменениями (docker)
* /sql - SQL-код поддержки pgmig (поддерживает встраивание как pgmig/pgmigsql)

### SQL-код поддержки pgmig

* Дополнение БД сервисным хранимым кодом для документирования, тестов и разграничения доступа

### Параллельные миграции

В текущей версии параддельные миграции не поддерживаются. В начале работы  ставится эксключивный лок до завершения

### Запросы вне транзакций

Если при выполнении миграции возникает необходимость выполнить действия вне транзакции (например `CRATE INDEX CONCURRENTLY`),
делается так:

1. `register_extra_sql(sql)`
2. pgmig --run-extra

Т.е. такие запросы собираются в отдельный буфер и потом могут быть выполнены или сразу после успешного выполнения миграции или отдельным вызовом pgmig


Параллельные миграции
